# ===========================================
# GitHub Actions - ECS Fargate CI/CD Pipeline
#
# åŠŸèƒ½ï¼š
# - Development: è‡ªå‹•éƒ¨ç½²ï¼ŒEmail é€šçŸ¥
# - Production: Staging â†’ Approval â†’ Production
# ===========================================

name: Deploy to ECS Fargate

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "theme_source/**"
      - "infrastructure/terraform/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - production
      force_deploy:
        description: "Force deployment even without changes"
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: project-wordpress-repo
  ECS_CLUSTER: project-ECS
  ECS_SERVICE: project-ECS-Service
  TASK_DEFINITION_FAMILY: project-wordpress-task-v2
  DOMAIN_NAME: evoger.tw
  # å¾ž terraform.tfvars è®€å–ï¼Œæˆ–ç”¨ workflow_dispatch æŒ‡å®š
  ENVIRONMENT: ${{ github.event.inputs.environment || 'development' }}

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Job 1: åµæ¸¬è®Šæ›´ & è¨­å®šç’°å¢ƒ
  # ============================================
  setup:
    name: Setup & Detect Changes
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decide.outputs.deploy }}
      environment: ${{ steps.env.outputs.environment }}
      is_production: ${{ steps.env.outputs.is_production }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            app:
              - 'src/**'
            infra:
              - 'infrastructure/terraform/**'

      - name: Decide deployment
        id: decide
        run: |
          if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.app }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.infra }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Set environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'development' }}"
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          if [[ "$ENV" == "production" ]]; then
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi
          echo "ðŸŽ¯ Target Environment: ${ENV}"

  # ============================================
  # Job 2: å»ºç½®ä¸¦æŽ¨é€ Docker Image
  # ============================================
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true'
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_uri: ${{ steps.build.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate image metadata
        id: meta
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          VERSION="${SHA_SHORT}-${TIMESTAMP}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.version }}
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          docker build \
            --cache-from ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t ${IMAGE_URI} \
            -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest \
            -f src/docker/Dockerfile \
            .

          docker push ${IMAGE_URI}
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build.outputs.image_uri }}
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

  # ============================================
  # Job 3a: Development éƒ¨ç½² (è‡ªå‹•ï¼Œä¸éœ€å¯©æ ¸)
  # ============================================
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      needs.setup.outputs.should_deploy == 'true' && 
      needs.setup.outputs.is_production == 'false'
    environment:
      name: development
      url: https://${{ env.DOMAIN_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.TASK_DEFINITION_FAMILY }} \
            --query 'taskDefinition' > task-def.json

      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def.json
          container-name: wordpress
          image: ${{ needs.build.outputs.image_uri }}

      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Comment, 'project')].Id" \
            --output text | head -1)

          if [[ -n "$DISTRIBUTION_ID" ]]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "âœ… CloudFront cache invalidated"
          fi

  # ============================================
  # Job 3b-1: Staging éƒ¨ç½² (Production æµç¨‹ç¬¬ä¸€æ­¥)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: |
      needs.setup.outputs.should_deploy == 'true' && 
      needs.setup.outputs.is_production == 'true'
    environment:
      name: staging
      url: https://staging.${{ env.DOMAIN_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.TASK_DEFINITION_FAMILY }} \
            --query 'taskDefinition' > task-def.json

      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def.json
          container-name: wordpress
          image: ${{ needs.build.outputs.image_uri }}

      - name: Deploy to ECS (Staging)
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: Smoke Test on Staging
        run: |
          echo "ðŸ§ª Running smoke tests on Staging..."
          sleep 30

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN_NAME }})
            if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "301" ]] || [[ "$HTTP_CODE" == "302" ]]; then
              echo "âœ… Staging smoke test passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_CODE, retrying..."
            sleep 10
          done

          echo "âŒ Staging smoke test failed"
          exit 1

  # ============================================
  # Job 3b-2: Production éƒ¨ç½² (éœ€è¦å¯©æ ¸)
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [setup, build, deploy-staging]
    if: |
      needs.setup.outputs.should_deploy == 'true' && 
      needs.setup.outputs.is_production == 'true'
    environment:
      name: production # â† é€™è£¡æœƒè§¸ç™¼ Approval Gate
      url: https://${{ env.DOMAIN_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.TASK_DEFINITION_FAMILY }} \
            --query 'taskDefinition' > task-def.json

      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def.json
          container-name: wordpress
          image: ${{ needs.build.outputs.image_uri }}

      - name: Deploy to ECS (Production)
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
          wait-for-minutes: 10

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Comment, 'project')].Id" \
            --output text | head -1)

          if [[ -n "$DISTRIBUTION_ID" ]]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
          fi

  # ============================================
  # Job 4: Smoke Test & é©—è­‰
  # ============================================
  verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [setup, deploy-development, deploy-production]
    if: |
      always() && 
      (needs.deploy-development.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: Health check
        run: |
          echo "ðŸ¥ Running health checks..."
          sleep 30

          # åŸºæœ¬å¥åº·æª¢æŸ¥
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN_NAME }})
            if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "301" ]] || [[ "$HTTP_CODE" == "302" ]]; then
              echo "âœ… Health check passed (HTTP $HTTP_CODE)"
              break
            fi
            echo "Attempt $i: HTTP $HTTP_CODE, retrying..."
            sleep 10
          done

      - name: WAF Protection Test
        run: |
          echo "ðŸ›¡ï¸ Testing WAF protection..."

          # SQL Injection test
          SQLI_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.DOMAIN_NAME }}/?id=1'%20OR%20'1'='1")
          if [[ "$SQLI_CODE" == "403" ]]; then
            echo "âœ… WAF SQLi protection working (HTTP 403)"
          else
            echo "âš ï¸ WAF SQLi test returned HTTP $SQLI_CODE"
          fi

          # XSS test
          XSS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.DOMAIN_NAME }}/?q=%3Cscript%3Ealert(1)%3C/script%3E")
          if [[ "$XSS_CODE" == "403" ]]; then
            echo "âœ… WAF XSS protection working (HTTP 403)"
          else
            echo "âš ï¸ WAF XSS test returned HTTP $XSS_CODE"
          fi

  # ============================================
  # Job 5: Email é€šçŸ¥
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [setup, build, verify, deploy-development, deploy-production]
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.deploy-development.result }}" == "success" ]] || [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-development.result }}" == "skipped" ]] && [[ "${{ needs.deploy-production.result }}" == "skipped" ]]; then
            echo "status=SKIPPED" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
          else
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Send Email via SNS
        if: steps.status.outputs.status != 'SKIPPED'
        run: |
          # å–å¾— SNS Topic ARN
          TOPIC_ARN=$(aws sns list-topics --query "Topics[?contains(TopicArn, 'project')].TopicArn" --output text | head -1)

          if [[ -z "$TOPIC_ARN" ]]; then
            echo "âš ï¸ SNS Topic not found, skipping notification"
            exit 0
          fi

          ENVIRONMENT="${{ needs.setup.outputs.environment }}"
          STATUS="${{ steps.status.outputs.status }}"
          EMOJI="${{ steps.status.outputs.emoji }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)
          ACTOR="${{ github.actor }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          SUBJECT="${EMOJI} [${ENVIRONMENT^^}] Deployment ${STATUS}"

          MESSAGE="${EMOJI} Deployment ${STATUS}

          ------------------------------------------
          Deployment Details
          ------------------------------------------
          Environment: ${ENVIRONMENT}
          Status: ${STATUS}
          Image Tag: ${IMAGE_TAG:-N/A}

          ------------------------------------------
          Commit Info
          ------------------------------------------
          SHA: ${COMMIT_SHA:0:7}
          Author: ${ACTOR}
          Message: ${COMMIT_MSG}

          ------------------------------------------
          Links
          ------------------------------------------
          Website: https://${{ env.DOMAIN_NAME }}
          Pipeline: ${RUN_URL}

          ------------------------------------------
          Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          "

          aws sns publish \
            --topic-arn "$TOPIC_ARN" \
            --subject "$SUBJECT" \
            --message "$MESSAGE"

          echo "ðŸ“§ Email notification sent!"

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Website | https://${{ env.DOMAIN_NAME }} |" >> $GITHUB_STEP_SUMMARY
